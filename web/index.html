<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pilot</title>
</head>
<body>
<div id="pad" style="height: 100%; position: fixed; width: 100%;"></div>
<script>
    const pad = document.getElementById('pad')
    const webSocket = new WebSocket('/')
    webSocket.onopen = () => {
        const input = {
            mouseMove: 0
        }
        let x, y
        let lastTickTime
        const tickInterval = 20
        const mouseDownButton = 1
        pad.onmousedown = (event) => {
            lastTickTime = 0
            x = event.clientX
            y = event.clientY
        }
        pad.onmousemove = (event) => {
            if (event.buttons === mouseDownButton) {
                handleMouseMove(event.clientX, event.clientY)
            }
        }
        let touchMoveHistory
        let firstTouchMove
        pad.ontouchstart = () => {
            lastTickTime = 0
            touchMoveHistory = []
            firstTouchMove = true
        }
        pad.ontouchmove = (event) => {
            event.preventDefault()
            const touch = event.touches[0]
            let newX = touch.clientX
            let newY = touch.clientY
            if (firstTouchMove) {
                x = newX
                y = newY
                firstTouchMove = false
            }
            touchMoveHistory.push([newX, newY])
            if (touchMoveHistory.length > 3) {
                touchMoveHistory.shift()
            }
            newX = touchMoveHistory.map((p) => p[0]).reduce((a, b) => a + b) / touchMoveHistory.length
            newY = touchMoveHistory.map((p) => p[1]).reduce((a, b) => a + b) / touchMoveHistory.length
            newX = Math.floor(newX)
            newY = Math.floor(newY)
            handleMouseMove(newX, newY)
        }
        /**
         * @param {number} newX
         * @param {number} newY
         */
        const handleMouseMove = (newX, newY) => {
            if (Date.now() - tickInterval > lastTickTime) {
                lastTickTime = Date.now()
                const movementX = newX - x
                const movementY = newY - y
                sendMouseMoveInput(movementX, movementY)
                x = newX
                y = newY
            }
        }
        /**
         * @param {number} movementX
         * @param {number} movementY
         */
        const sendMouseMoveInput = (movementX, movementY) => {
            movementX = Math.max(0, Math.min(255, movementX + 128))
            movementY = Math.max(0, Math.min(255, movementY + 128))
            const bytes = new Uint8Array([input.mouseMove, movementX, movementY])
            webSocket.send(bytes)
        }
    }
    webSocket.onclose = () => {
        pad.onmousedown = null
        pad.onmousemove = null
        pad.ontouchstart = null
        pad.ontouchmove = null
    }
</script>
</body>
</html>